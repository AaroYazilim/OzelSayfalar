<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stok Miktar Raporu</title>

    <!-- Gerekli CDN'ler -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
<script class="AaroOnTanimGecici">
        var Aaro = {
            "SayfaKodu": "PersonelPuantajRaporu",
            "SayfaAdi": "Personel Puantaj Raporu",
            "AnaUrl": "https://localhost:44346/",
            "Tarih": "2025-09-22 14:26:41",
            "IsAuthenticated": "True",
            "UserIP": "127.0.0.1",
            "Oturum": {
                "KullaniciKodu": "yonetici@temel",
                "KullaniciAdi": "A Kullanicisi",
                "KullaniciID": "2",
                "GrupAdi": "Temel",
                "SirketID": "0",
                "SubeID": "0",
                "SirketAdi": "Tüm Şirketler",
                "SubeAdi": "Tüm Şubeler",
                "KullaniciGrupID": "2",
                "KullaniciGrupKodu": "YNTC",
                "KullaniciGrupAdi": "Yönetici Grubu",
                "Token": ":)"
            },
            "QueryString": {},
            "Form": {}
        }
    </script>
    <!-- Özel Kurumsal CSS Stilleri -->
    <style>
        :root {
            --kurumsal-mavi: #0d47a1;
            --kurumsal-acik-mavi: #1976d2;
            --kurumsal-gri: #f5f7fa;
            --kurumsal-kenarlik: #dee2e6;
            --kurumsal-golge: 0 4px 12px rgba(0, 0, 0, 0.08);
            --kurumsal-yazi: #212529;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--kurumsal-gri);
            color: var(--kurumsal-yazi);
        }
        .card {
            border: 1px solid var(--kurumsal-kenarlik);
            border-radius: 0.5rem;
            box-shadow: var(--kurumsal-golge);
            overflow: hidden;
        }
        .card-header {
            background-color: #fff;
            color: var(--kurumsal-mavi);
            font-weight: 600;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--kurumsal-kenarlik);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .btn { border-radius: 0.375rem; font-weight: 500; transition: all 0.2s ease; }
        .btn-primary { background-color: var(--kurumsal-mavi); border-color: var(--kurumsal-mavi); }
        .btn-primary:hover { background-color: #0b3a82; border-color: #0b3a82; transform: translateY(-1px); }
        .form-control { border-radius: 0.375rem; border: 1px solid var(--kurumsal-kenarlik); }
        .form-control:focus { border-color: var(--kurumsal-acik-mavi); box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25); }
        .accordion .card { box-shadow: none; }
        .accordion .card-header { cursor: pointer; transition: background-color 0.2s ease-in-out; }
        .accordion .card-header:hover { background-color: var(--kurumsal-gri); }
        .accordion .card-header .accordion-icon::before { font-family: 'Font Awesome 5 Free'; content: "\f078"; font-weight: 900; transition: transform 0.3s ease; }
        .accordion .card-header[aria-expanded="true"] .accordion-icon::before { transform: rotate(-180deg); }
        .accordion .card-body { border-top: 1px solid var(--kurumsal-kenarlik); }
        .nav-tabs { border-bottom: 2px solid var(--kurumsal-kenarlik); }
        .nav-tabs .nav-link { border: none; border-bottom: 2px solid transparent; color: #6c757d; font-weight: 500; margin-bottom: -2px; }
        .nav-tabs .nav-link:hover { border-bottom-color: var(--kurumsal-acik-mavi); color: var(--kurumsal-acik-mavi); }
        .nav-tabs .nav-link.active { color: var(--kurumsal-mavi); background-color: transparent; border-bottom: 2px solid var(--kurumsal-mavi); }

        /* Yeni Kart Tasarımı */
        .stok-karti {
            border: none;
            border-radius: .5rem;
            box-shadow: 0 2px 8px rgba(0,0,0, .07);
            transition: transform .2s ease, box-shadow .2s ease;
        }
        .stok-karti:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0, .1);
        }
        .stok-karti .card-header { background-color: #fff; border-bottom: 1px solid #f0f0f0; }
        .stok-karti .stok-adi { font-size: 1.1rem; font-weight: 600; color: var(--kurumsal-yazi); }
        .stok-karti .stok-kodu { font-size: .9rem; color: #6c757d; font-family: monospace; }
        .stok-karti .depo-listesi { list-style: none; padding-left: 0; margin-bottom: 0; }
        .stok-karti .depo-listesi li { display: flex; justify-content: space-between; padding: .75rem 1.25rem; border-bottom: 1px solid #f5f5f5; }
        .stok-karti .depo-listesi li:last-child { border-bottom: none; }
        .stok-karti .depo-miktar { font-weight: 600; color: var(--kurumsal-mavi); }
        
        /* Yazdırma ve Karşılaştırma Stilleri */
        .degisim.pozitif { color: #28a745; }
        .degisim.negatif { color: #dc3545; }
        @media print {
            body * { visibility: hidden; }
            #yazdirmaAlani, #yazdirmaAlani * { visibility: visible; }
            #yazdirmaAlani { position: absolute; left: 0; top: 0; width: 100%; }
            .table { font-size: 10pt; }
        }
    </style>
</head>
<body>
    <div class="container-fluid my-4">
        <!-- SAYFA BAŞLIĞI -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 id="sayfa-adi" class="mb-0">Stok Miktar Raporu</h2>
        </div>

        <!-- FİLTRELER ACCORDION -->
        <div class="accordion" id="filtreAccordion">
            <div class="card">
                <div class="card-header collapsed" id="filtreHeading" data-toggle="collapse" data-target="#collapseFiltre" aria-expanded="true" aria-controls="collapseFiltre">
                    <span><i class="fas fa-filter mr-2"></i> Filtreleme Seçenekleri</span>
                    <span class="accordion-icon"></span>
                </div>
                <div id="collapseFiltre" class="collapse show" aria-labelledby="filtreHeading" data-parent="#filtreAccordion">
                    <div class="card-body">
                        <form id="filtreForm">
                             <div class="row align-items-end">
                                <div class="col-md-3"><div class="form-group"><label for="tarihBit">Ana Rapor Tarihi</label><input type="text" class="form-control" id="tarihBit" placeholder="Tarih Seçin"></div></div>
                                <div class="col-md-3"><div class="form-group"><label for="stokKoduBas">Stok Kodu Başlangıcı</label><input type="text" class="form-control" id="stokKoduBas" placeholder="Örn: LC-345"></div></div>
                                <div class="col-md-3"><div class="form-group"><label for="stokAdiBas">Stok Adı Başlangıcı</label><input type="text" class="form-control" id="stokAdiBas" placeholder="Örn: BBL"></div></div>
                                <div class="col-md-3"><div class="form-group mb-0"><button type="button" id="raporGetirBtn" class="btn btn-primary btn-block"><span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span><i class="fas fa-search mr-1"></i> Raporu Getir</button></div></div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- SONUÇ ALANI -->
        <div class="card mt-4">
            <div class="card-body">
                <!-- NAV-TABS -->
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation"><a class="nav-link active" id="liste-tab" data-toggle="tab" href="#liste" role="tab" aria-controls="liste" aria-selected="true"><i class="fas fa-list mr-2"></i>Liste</a></li>
                    <li class="nav-item" role="presentation"><a class="nav-link" id="karsilastir-tab" data-toggle="tab" href="#karsilastir" role="tab" aria-controls="karsilastir" aria-selected="false"><i class="fas fa-exchange-alt mr-2"></i>Karşılaştır</a></li>
                    <li class="nav-item" role="presentation"><a class="nav-link" id="grafik-tab" data-toggle="tab" href="#grafik" role="tab" aria-controls="grafik" aria-selected="false"><i class="fas fa-chart-bar mr-2"></i>Genel Grafikler</a></li>
                    <li class="nav-item" role="presentation"><a class="nav-link" id="yazdir-tab" data-toggle="tab" href="#yazdir" role="tab" aria-controls="yazdir" aria-selected="false"><i class="fas fa-print mr-2"></i>Yazdır</a></li>
                </ul>

                <!-- TAB-CONTENT -->
                <div class="tab-content pt-3" id="myTabContent">
                    <div class="tab-pane fade show active" id="liste" role="tabpanel" aria-labelledby="liste-tab">
                        <div id="rapor-sonuc"><div class="alert alert-info text-center">Lütfen raporu getirmek için yukarıdaki filtreleri kullanın.</div></div>
                        <nav id="sayfalandirmaNav" class="d-none mt-3"><ul class="pagination justify-content-center"></ul></nav>
                    </div>
                    <div class="tab-pane fade" id="karsilastir" role="tabpanel" aria-labelledby="karsilastir-tab">
                         <div class="row align-items-end">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="karsilastirmaTarih">Karşılaştırma Tarihi</label>
                                    <input type="text" class="form-control" id="karsilastirmaTarih">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-success" id="karsilastirBtn" disabled><i class="fas fa-sync-alt mr-2"></i>Karşılaştır</button>
                            </div>
                         </div>
                         <hr>
                         <div id="karsilastirmaSonuc" class="mt-3"><div class="alert alert-info">Karşılaştırma yapmak için önce ana raporu getirin, ardından bir karşılaştırma tarihi seçip butona tıklayın.</div></div>
                    </div>
                    <div class="tab-pane fade" id="grafik" role="tabpanel" aria-labelledby="grafik-tab">
                        <div id="genelGrafikAlani" class="text-center"><div class="alert alert-info">Genel rapor grafikleri için lütfen önce bir arama yapın.</div></div>
                    </div>
                    <div class="tab-pane fade" id="yazdir" role="tabpanel" aria-labelledby="yazdir-tab">
                        <div id="yazdirmaAlaniWrapper">
                            <div class="d-flex justify-content-end mb-3"><button class="btn btn-secondary" id="yazdirBtn"><i class="fas fa-print mr-2"></i>Yazdır</button></div>
                            <div id="yazdirmaTablosu"><div class="alert alert-info text-center">Yazdırma görünümü için lütfen önce bir arama yapın.</div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Grafik Modal -->
    <div class="modal fade" id="grafikModal" tabindex="-1" aria-labelledby="grafikModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="grafikModalLabel">Stok Dağılım Grafiği</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body"><canvas id="stokPastaGrafigi" style="max-height: 400px;"></canvas></div></div></div>
    </div>

    <!-- JS Kütüphaneleri -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        $(document).ready(function() {
            // --- Değişkenler ---
            const bearerToken = ':)';
            const endpoint = 'https://erp.aaro.com.tr/api/Stok/StokMiktarListe';
            let modalChart = null, genelGrafik = null;

            // --- Tarih Seçiciler ---
            new Litepicker({ element: document.getElementById('tarihBit'), singleMode: true, allowRepick: true, format: 'YYYY-MM-DD', lang: 'tr-TR' }).setDate(new Date());
            new Litepicker({ element: document.getElementById('karsilastirmaTarih'), singleMode: true, allowRepick: true, format: 'YYYY-MM-DD', lang: 'tr-TR' });

            // --- Olay Dinleyiciler ---
            $('#raporGetirBtn').on('click', () => raporuGetir(1));
            $('#karsilastirBtn').on('click', karsilastirmayiBaslat);
            $('#yazdirBtn').on('click', () => window.print());
            $('#rapor-sonuc').on('click', '.grafik-goster-btn', grafikModalGoster);
            $('#sayfalandirmaNav').on('click', '.page-link', function(e) {
                e.preventDefault();
                if ($(this).parent().hasClass('disabled')) return;
                raporuGetir($(this).data('sayfa'));
            });

            // --- Ana Rapor Fonksiyonları ---
            function raporuGetir(sayfa) {
                const btn = $('#raporGetirBtn');
                const sonucAlani = $('#rapor-sonuc');
                const yazdirmaTablosuAlani = $('#yazdirmaTablosu');
                btn.prop('disabled', true).find('.spinner-border').removeClass('d-none');
                
                const filtreler = { TarihBit: $('#tarihBit').val(), StokKoduBas: $('#stokKoduBas').val(), StokAdiBas: $('#stokAdiBas').val(), Sayfa: sayfa, SayfaSatirSayisi: 100 };
                Object.keys(filtreler).forEach(key => !filtreler[key] && delete filtreler[key]);

                sonucAlani.html(`<div class="text-center p-5"><i class="fas fa-spinner fa-spin fa-3x text-primary"></i></div>`);
                $('#sayfalandirmaNav').addClass('d-none');
                $('#genelGrafikAlani, #yazdirmaTablosu, #karsilastirmaSonuc').html('<div class="alert alert-info">...</div>');
                $('#karsilastirBtn').prop('disabled', true);

                $.ajax({ url: endpoint, method: 'GET', headers: { 'Accept': 'application/json', 'Authorization': 'Bearer ' + bearerToken }, data: filtreler })
                .done(function(response) {
                    if (response && response.Model && response.Model.length > 0) {
                        sonuclariGoster(veriyiGrupla(response.Model));
                        genelGrafigiOlustur(response.Model);
                        yazdirmaTablosuOlustur(response.Model);
                        sayfalandirmayiOlustur(response.SayfalandirmaBilgisi);
                        $('#karsilastirBtn').prop('disabled', false);
                        $('#karsilastirmaSonuc').html('<div class="alert alert-info">Karşılaştırma yapmak için bir tarih seçip butona tıklayın.</div>');
                    } else {
                        const mesaj = '<div class="alert alert-warning text-center">Belirtilen kriterlere uygun stok bulunamadı.</div>';
                        sonucAlani.html(mesaj);
                        yazdirmaTablosuAlani.html(mesaj);
                    }
                })
                .fail(() => {
                    const hataMesaji = '<div class="alert alert-danger text-center">Veriler çekilirken bir hata oluştu.</div>';
                    sonucAlani.html(hataMesaji);
                    yazdirmaTablosuAlani.html(hataMesaji);
                })
                .always(() => btn.prop('disabled', false).find('.spinner-border').addClass('d-none'));
            }

            function sonuclariGoster(gruplanmisStoklar) {
                const sonucAlani = $('#rapor-sonuc');
                sonucAlani.empty();
                for (const stokId in gruplanmisStoklar) {
                    const stok = gruplanmisStoklar[stokId];
                    const toplamMiktar = stok.depolar.reduce((sum, d) => sum + d.Miktar, 0);
                    const kartHtml = `
                        <div class="card stok-karti mb-3">
                            <div class="card-header">
                                <div>
                                    <div class="stok-adi">${stok.StokAdi}</div>
                                    <div class="stok-kodu">${stok.StokKodu}</div>
                                </div>
                                <div class="text-right">
                                    <span class="badge badge-secondary d-block mb-2">Toplam: ${toplamMiktar.toLocaleString('tr-TR')} ${stok.depolar[0]?.Birim || ''}</span>
                                    <button class="btn btn-sm btn-outline-primary grafik-goster-btn"
                                            data-stok-adi="${stok.StokAdi}" data-labels='${JSON.stringify(stok.depolar.map(d => d.DepoAdi))}' data-miktarlar='${JSON.stringify(stok.depolar.map(d => d.Miktar))}'>
                                        <i class="fas fa-chart-pie mr-1"></i> Grafik
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0"><ul class="depo-listesi">${stok.depolar.map(d => `<li><span>${d.DepoAdi}</span> <span class="depo-miktar">${d.Miktar.toLocaleString('tr-TR')} ${d.Birim}</span></li>`).join('')}</ul></div>
                        </div>`;
                    sonucAlani.append(kartHtml);
                }
            }

            // --- Karşılaştırma Fonksiyonları (Yenilendi) ---
            function karsilastirmayiBaslat() {
                const karsilastirmaTarihi = $('#karsilastirmaTarih').val();
                if (!karsilastirmaTarihi) {
                    alert('Lütfen bir karşılaştırma tarihi seçin.');
                    return;
                }
                
                const sonucAlani = $('#karsilastirmaSonuc');
                sonucAlani.html(`<div class="text-center p-5"><i class="fas fa-spinner fa-spin fa-3x text-primary"></i><p class="mt-2">Karşılaştırma verileri yükleniyor...</p></div>`);

                const baseFilters = {
                    StokKoduBas: $('#stokKoduBas').val(), StokAdiBas: $('#stokAdiBas').val(),
                    SayfaSatirSayisi: 10000 // Karşılaştırma için çok sayıda kayıt çek
                };

                const anaVeriPromise = $.ajax({ url: endpoint, method: 'GET', headers: { 'Accept': 'application/json', 'Authorization': 'Bearer ' + bearerToken }, data: { ...baseFilters, TarihBit: $('#tarihBit').val() } });
                const karsilastirmaVeriPromise = $.ajax({ url: endpoint, method: 'GET', headers: { 'Accept': 'application/json', 'Authorization': 'Bearer ' + bearerToken }, data: { ...baseFilters, TarihBit: karsilastirmaTarihi } });

                Promise.all([anaVeriPromise, karsilastirmaVeriPromise])
                    .then(([anaResponse, karsilastirmaResponse]) => {
                        const anaVeri = anaResponse.Model || [];
                        const karsilastirmaVeri = karsilastirmaResponse.Model || [];

                        if (anaVeri.length === 0 && karsilastirmaVeri.length === 0) {
                            sonucAlani.html('<div class="alert alert-warning">Her iki tarih için de veri bulunamadı.</div>');
                            return;
                        }
                        karsilastirmaTablosuOlustur(anaVeri, karsilastirmaVeri);
                    })
                    .catch(() => {
                        sonucAlani.html('<div class="alert alert-danger">Karşılaştırma verisi alınırken hata oluştu.</div>');
                    });
            }

            function karsilastirmaTablosuOlustur(anaVeri, karsilastirmaVeri) {
                const birlesikVeri = {};

                anaVeri.forEach(item => {
                    const key = `${item.StokID}-${item.DepoID}`;
                    birlesikVeri[key] = { StokKodu: item.StokKodu, StokAdi: item.StokAdi, DepoAdi: item.DepoAdi, Miktar1: item.Miktar, Miktar2: 0 };
                });

                karsilastirmaVeri.forEach(item => {
                    const key = `${item.StokID}-${item.DepoID}`;
                    if (birlesikVeri[key]) {
                        birlesikVeri[key].Miktar2 = item.Miktar;
                    } else {
                        birlesikVeri[key] = { StokKodu: item.StokKodu, StokAdi: item.StokAdi, DepoAdi: item.DepoAdi, Miktar1: 0, Miktar2: item.Miktar };
                    }
                });

                const sortedKeys = Object.keys(birlesikVeri).sort((a, b) => (birlesikVeri[a].StokKodu + birlesikVeri[a].DepoAdi).localeCompare(birlesikVeri[b].StokKodu + birlesikVeri[b].DepoAdi));
                
                if (sortedKeys.length === 0) {
                    $('#karsilastirmaSonuc').html('<div class="alert alert-info text-center">Karşılaştırılacak veri bulunamadı.</div>');
                    return;
                }

                let tabloSatirlari = '';
                sortedKeys.forEach(key => {
                    const veri = birlesikVeri[key];
                    const degisim = veri.Miktar2 - veri.Miktar1;

                    let degisimHtml;
                    if (degisim > 0) {
                        degisimHtml = `<span class="degisim pozitif"><i class="fas fa-arrow-up"></i> ${degisim.toLocaleString('tr-TR')}</span>`;
                    } else if (degisim < 0) {
                        degisimHtml = `<span class="degisim negatif"><i class="fas fa-arrow-down"></i> ${degisim.toLocaleString('tr-TR')}</span>`;
                    } else {
                        degisimHtml = `<span>-</span>`;
                    }

                    tabloSatirlari += `<tr><td>${veri.StokKodu}</td><td>${veri.StokAdi}</td><td>${veri.DepoAdi}</td><td class="text-right">${veri.Miktar1.toLocaleString('tr-TR')}</td><td class="text-right">${veri.Miktar2.toLocaleString('tr-TR')}</td><td class="text-right">${degisimHtml}</td></tr>`;
                });

                const tabloHtml = `
                    <table class="table table-bordered table-hover table-sm">
                        <thead class="thead-light">
                            <tr><th>Stok Kodu</th><th>Stok Adı</th><th>Depo</th><th class="text-right">${$('#tarihBit').val()}</th><th class="text-right">${$('#karsilastirmaTarih').val()}</th><th class="text-right">Değişim</th></tr>
                        </thead>
                        <tbody>${tabloSatirlari}</tbody>
                    </table>`;
                $('#karsilastirmaSonuc').html(tabloHtml);
            }

            // --- Diğer Yardımcı Fonksiyonlar ---
            const veriyiGrupla = stokListesi => stokListesi.reduce((acc, item) => { (acc[item.StokID] = acc[item.StokID] || { ...item, depolar: [] }).depolar.push(item); return acc; }, {});
            
            function yazdirmaTablosuOlustur(stokListesi) {
                const alan = $('#yazdirmaTablosu');
                if (!stokListesi || stokListesi.length === 0) return;
                const tumDepolar = [...new Set(stokListesi.map(item => item.DepoAdi))].sort();
                const stoklar = stokListesi.reduce((acc, item) => { (acc[item.StokID] = acc[item.StokID] || { ...item, depoMiktarlari: {} }).depoMiktarlari[item.DepoAdi] = item.Miktar; return acc; }, {});
                const depoBasliklari = tumDepolar.map(d => `<th>${d}</th>`).join('');
                let tabloSatirlari = '';
                for(const stokId in stoklar) {
                    const stok = stoklar[stokId];
                    tabloSatirlari += `<tr><td>${stok.StokKodu}</td><td>${stok.StokAdi}</td>${tumDepolar.map(d => `<td>${stok.depoMiktarlari[d]?.toLocaleString('tr-TR') || '-'}</td>`).join('')}</tr>`;
                }
                alan.html(`<div id="yazdirmaAlani"><h4 class="mb-3 text-center">Stok Miktar Raporu</h4><table class="table table-bordered table-sm"><thead class="thead-light"><tr><th>Stok Kodu</th><th>Stok Adı</th>${depoBasliklari}</tr></thead><tbody>${tabloSatirlari}</tbody></table></div>`);
            }

            function sayfalandirmayiOlustur(bilgi) {
                const nav = $('#sayfalandirmaNav'), ul = nav.find('.pagination');
                ul.empty();
                if (bilgi.ToplamSayfaSayisi <= 1) return nav.addClass('d-none');
                nav.removeClass('d-none');
                const sayfaLinkleri = (start, end) => { let l = ''; for (let i = start; i <= end; i++) l += `<li class="page-item ${i === bilgi.Sayfa ? 'active' : ''}"><a class="page-link" href="#" data-sayfa="${i}">${i}</a></li>`; return l; };
                let start = Math.max(1, bilgi.Sayfa - 3), end = Math.min(bilgi.ToplamSayfaSayisi, bilgi.Sayfa + 3);
                ul.append(`<li class="page-item ${!bilgi.OncekiSayfaVarMi ? 'disabled' : ''}"><a class="page-link" href="#" data-sayfa="${bilgi.Sayfa - 1}">Önceki</a></li>`);
                ul.append(sayfaLinkleri(start, end));
                ul.append(`<li class="page-item ${!bilgi.SonrakiSayfaVarMi ? 'disabled' : ''}"><a class="page-link" href="#" data-sayfa="${bilgi.Sayfa + 1}">Sonraki</a></li>`);
            }

            function grafikModalGoster() {
                const btn = $(this);
                $('#grafikModalLabel').text(btn.data('stok-adi'));
                if (modalChart) modalChart.destroy();
                modalChart = new Chart($('#stokPastaGrafigi').get(0).getContext('d'), { type: 'pie', data: { labels: btn.data('labels'), datasets: [{ data: btn.data('miktarlar') }] } });
                $('#grafikModal').modal('show');
            }

            function genelGrafigiOlustur(stokListesi) {
                const alan = $('#genelGrafikAlani');
                alan.html('<canvas id="genelRaporGrafigi" style="max-height: 450px;"></canvas>');
                const toplamStoklar = stokListesi.reduce((acc, item) => { acc[item.StokAdi] = (acc[item.StokAdi] || 0) + item.Miktar; return acc; }, {});
                const siraliStoklar = Object.entries(toplamStoklar).sort((a, b) => b[1] - a[1]).slice(0, 15);
                if(genelGrafik) genelGrafik.destroy();
                genelGrafik = new Chart($('#genelRaporGrafigi').get(0).getContext('2d'), { type: 'bar', data: { labels: siraliStoklar.map(item => item[0]), datasets: [{ label: 'Toplam Stok Miktarı', data: siraliStoklar.map(item => item[1]), backgroundColor: 'rgba(13, 71, 161, 0.7)' }] }, options: { indexAxis: 'y', responsive: true } });
            }
        });
    </script>
</body>
</html>

