<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Üretim Hesaplama Aracı | AARO</title>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Tom Select -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">

    <style>
        :root {
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --primary-color: #2563eb;
            /* Royal Blue */
            --primary-hover: #1d4ed8;
            --text-main: #111827;
            --text-muted: #6b7280;
            --border-color: #e5e7eb;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --card-radius: 16px;
            --input-radius: 10px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-highlight: 0 10px 15px -3px rgba(37, 99, 235, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            padding-bottom: 80px;
            -webkit-font-smoothing: antialiased;
        }

        /* --- Header --- */
        .app-header {
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            padding: 1.25rem 0;
            margin-bottom: 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .brand-title {
            font-weight: 700;
            color: var(--text-main);
            font-size: 1.5rem;
            letter-spacing: -0.025em;
        }

        .brand-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* --- Cards --- */
        .custom-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: box-shadow 0.2s ease;
            margin-bottom: 1.5rem;
        }

        .custom-card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header-styled {
            background: transparent;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title-text {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-main);
            margin: 0;
        }

        .card-body-styled {
            padding: 1.5rem;
        }

        /* --- Form Elements --- */
        .form-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.4rem;
        }

        .form-control,
        .form-select {
            border-radius: var(--input-radius);
            border: 1px solid var(--border-color);
            padding: 0.65rem 0.85rem;
            font-size: 0.95rem;
            color: var(--text-main);
            background-color: #f9fafb;
            transition: all 0.2s;
        }

        .form-control:focus,
        .form-select:focus {
            background-color: #fff;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        /* --- Buttons --- */
        .btn-primary-custom {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: var(--input-radius);
            font-weight: 600;
            transition: all 0.2s;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary-custom:hover:not(:disabled) {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-highlight);
        }

        .btn-primary-custom:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
            transform: none;
        }

        /* --- Dashboard Widgets --- */
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--card-radius);
            padding: 1.25rem;
            text-align: center;
            height: 100%;
            box-shadow: var(--shadow-sm);
        }

        .stat-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--primary-color);
            line-height: 1.2;
        }

        .stat-input-wrapper input {
            font-family: 'Inter', sans-serif;
            color: var(--primary-color);
        }

        /* --- Table --- */
        .table-rounded {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.95rem;
        }

        .table-rounded th {
            background-color: #f9fafb;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .table-rounded td {
            background-color: #fff;
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            vertical-align: middle;
            color: var(--text-main);
        }

        .table-rounded tr:last-child td {
            border-bottom: none;
        }

        .measure-badge {
            font-family: 'Menlo', monospace;
            background-color: #eff6ff;
            color: var(--primary-color);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* --- Timeline Steps --- */
        .timeline-container {
            position: relative;
            padding-left: 20px;
        }

        .timeline-step {
            position: relative;
            padding: 0 0 2rem 2.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .timeline-step:last-child {
            padding-bottom: 0;
        }

        .timeline-marker {
            position: absolute;
            left: 0;
            top: 0;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.9rem;
            z-index: 2;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .timeline-connector {
            position: absolute;
            left: 17px;
            top: 36px;
            bottom: 0;
            width: 2px;
            background: var(--border-color);
            z-index: 1;
        }

        .timeline-step:last-child .timeline-connector {
            display: none;
        }

        /* States */
        .timeline-step.active .timeline-marker {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: #fff;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2);
        }

        .timeline-step.success .timeline-marker {
            border-color: var(--success-color);
            background: var(--success-color);
            color: #fff;
        }

        .timeline-step.error .timeline-marker {
            border-color: var(--danger-color);
            background: var(--danger-color);
            color: #fff;
        }

        .timeline-content h6 {
            margin: 0;
            font-weight: 600;
            font-size: 1rem;
        }

        .timeline-content p {
            margin: 4px 0 0;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .timeline-step:hover .timeline-content h6 {
            color: var(--primary-color);
        }

        /* --- JSON Viewer --- */
        pre.json-view {
            background-color: #1f2937;
            color: #e5e7eb;
            padding: 1.5rem;
            border-radius: var(--card-radius);
            font-size: 0.85rem;
            line-height: 1.5;
            max-height: 500px;
            overflow: auto;
        }

        .string {
            color: #a5d6ff;
        }

        .number {
            color: #fca5a5;
        }

        .boolean {
            color: #6ee7b7;
        }

        .null {
            color: #d1d5db;
        }

        .key {
            color: #fcd34d;
        }

        /* --- Animations --- */
        .animate-in {
            animation: slideUp 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes slideUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Tom Select Overrides --- */
        .ts-control {
            border-radius: var(--input-radius);
            border: 1px solid var(--border-color) !important;
            padding: 0.65rem 0.85rem !important;
            box-shadow: none !important;
        }

        .ts-dropdown {
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            padding: 0.5rem;
        }

        .ts-dropdown .option {
            border-radius: 6px;
            padding: 8px 12px;
        }

        .ts-dropdown .active {
            background-color: #eff6ff;
            color: var(--primary-color);
        }
    </style>
</head>

<body>

    <!-- Header -->
    <header class="app-header">
        <div class="container d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-3">
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center"
                    style="width: 48px; height: 48px; font-size: 1.25rem;">
                    <i class="fa-solid fa-industry"></i>
                </div>
                <div>
                    <div class="brand-title">Üretim Hesaplama</div>
                    <div class="brand-subtitle">AARO Entegrasyon Sistemi</div>
                </div>
            </div>
            <!-- Optional Actions -->
            <button class="btn btn-outline-secondary btn-sm rounded-pill px-3" onclick="window.location.reload()">
                <i class="fa-solid fa-rotate-right me-2"></i>Sıfırla
            </button>
        </div>
    </header>

    <div class="container animate-in">
        <div class="row g-4">

            <!-- Left Sidebar: Parameters -->
            <div class="col-lg-4">
                <div class="custom-card h-100">
                    <div class="card-header-styled">
                        <span class="card-title-text"><i
                                class="fa-solid fa-sliders me-2 text-primary"></i>Parametreler</span>

                        <select class="form-select form-select-sm w-auto" id="productGroup" style="min-width: 140px;">
                            <option value="default">Varsayılan</option>
                            <option value="group1">Grup 1</option>
                            <option value="group2">Grup 2</option>
                            <option value="group3">Grup 3</option>
                        </select>
                    </div>
                    <div class="card-body-styled">
                        <form id="calcForm">
                            <div class="mb-4">
                                <label class="form-label">Soğutucu Modeli</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0 text-muted"><i
                                            class="fa-solid fa-tag"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" id="modelType"
                                        placeholder="Örn: JCB 200">
                                </div>
                            </div>

                            <div class="bg-light p-3 rounded-3 mb-4">
                                <h6 class="text-uppercase text-muted fw-bold mb-3" style="font-size: 0.75rem;">Petek
                                    Ölçüleri (mm)</h6>
                                <div class="row g-3">
                                    <div class="col-6">
                                        <label class="form-label">Boy</label>
                                        <input type="number" class="form-control" id="petekBoyu" value="860">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">En</label>
                                        <input type="number" class="form-control" id="petekEni" value="430">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Kalınlık</label>
                                        <input type="number" class="form-control" id="kalinlik" value="115">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Sıra Sayısı</label>
                                        <input type="number" class="form-control" id="siraSayisi" value="30">
                                    </div>
                                </div>
                            </div>

                            <div class="bg-light p-3 rounded-3 mb-4">
                                <h6 class="text-uppercase text-muted fw-bold mb-3" style="font-size: 0.75rem;">Bileşen
                                    Detayları (mm)</h6>
                                <div class="row g-3">
                                    <div class="col-6">
                                        <label class="form-label">İç Fin</label>
                                        <input type="number" class="form-control" id="icFinKalinlik" step="0.1"
                                            value="3">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Dış Fin</label>
                                        <input type="number" class="form-control" id="disFinKalinlik" step="0.1"
                                            value="10.3">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">ALM Klad</label>
                                        <input type="number" class="form-control" id="almKladKalinlik" step="0.1"
                                            value="0.6">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Adet</label>
                                        <input type="number" class="form-control" id="sogutucuAdedi" value="2">
                                    </div>
                                </div>
                            </div>

                            <button type="button" class="btn-primary-custom" onclick="calculate()">
                                <i class="fa-solid fa-calculator"></i> Hesapla
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Right Content: Results & Process -->
            <div class="col-lg-8">

                <!-- Quick Stats -->
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="stat-card">
                            <div class="stat-label">Yan Kuşak Kalınlığı</div>
                            <div class="stat-value" id="resYanKusakKalinligi">-</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card"
                            style="background-color: #f0f7ff; border: 2px solid var(--primary-color);">
                            <div class="stat-label text-primary" style="font-weight: 700;">Sabit Sayı</div>
                            <div class="stat-input-wrapper mt-1">
                                <input type="number"
                                    class="form-control text-center bg-transparent border-0 p-0 fw-bold text-primary"
                                    id="resSabitSayi" step="0.1" style="font-size: 2.5rem; box-shadow: none;">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card">
                            <div class="stat-label">Toplam Parça</div>
                            <div class="stat-value text-dark" id="resToplamParca">-</div>
                        </div>
                    </div>
                </div>

                <!-- Main Table -->
                <div class="custom-card">
                    <div class="card-header-styled">
                        <span class="card-title-text"><i class="fa-solid fa-list-check me-2 text-success"></i>İş Takibi
                            & Hesaplar</span>
                    </div>
                    <div class="card-body-styled p-0 overflow-hidden">
                        <div class="table-responsive">
                            <table class="table-rounded">
                                <thead>
                                    <tr>
                                        <th style="width: 20%">Bileşen</th>
                                        <th style="width: 25%">Hesaplanan Ölçü</th>
                                        <th style="width: 10%" class="text-center">Adet</th>
                                        <th style="width: 25%">Stok Bağlantısı</th>
                                        <th style="width: 20%">Notlar</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsBody">
                                    <!-- JS Populates -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Integration Process -->
                <div class="custom-card border-primary" style="border-width: 2px;">
                    <div class="card-header-styled bg-primary bg-opacity-10">
                        <span class="card-title-text text-primary"><i class="fa-solid fa-network-wired me-2"></i>AARO
                            Entegrasyon</span>
                    </div>
                    <div class="card-body-styled">
                        <div class="row g-3 mb-4">
                            <div class="col-md-5">
                                <label class="form-label">Reçete Kodu</label>
                                <input type="text" class="form-control" id="receteKodu" placeholder="REC-YYYY-001">
                            </div>
                            <div class="col-md-7">
                                <label class="form-label">Reçete Açıklaması</label>
                                <div class="d-flex gap-2">
                                    <input type="text" class="form-control" id="receteAdi"
                                        placeholder="Üretim Reçetesi...">
                                    <button class="btn btn-primary btn-lg shadow-sm px-4"
                                        onclick="startIntegrationProcess()" id="startProcessBtn"
                                        style="white-space: nowrap;">
                                        <i class="fa-solid fa-play"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <hr class="border-light my-4">

                        <h6 class="text-muted fw-bold text-uppercase mb-4"
                            style="font-size: 0.8rem; letter-spacing: 0.05em;">İşlem Akışı</h6>

                        <div class="timeline-container" id="processSteps">
                            <!-- Step 1 -->
                            <div class="timeline-step" id="step_recipe" onclick="showStepDetails('step_recipe')">
                                <div class="timeline-connector"></div>
                                <div class="timeline-marker"><i class="fa-solid fa-1"></i></div>
                                <div class="timeline-content">
                                    <h6 class="text-dark">Reçete Kartı Oluşturma</h6>
                                    <p id="status_recipe">Başlangıç Bekleniyor...</p>
                                </div>
                            </div>

                            <!-- Step 2 -->
                            <div class="timeline-step" id="step_fetch_ingredients"
                                onclick="showStepDetails('step_fetch_ingredients')">
                                <div class="timeline-connector"></div>
                                <div class="timeline-marker"><i class="fa-solid fa-2"></i></div>
                                <div class="timeline-content">
                                    <h6 class="text-dark">Hammadde Verilerini Çekme</h6>
                                    <p id="status_fetch_ingredients">Bekleniyor...</p>
                                </div>
                            </div>

                            <!-- Step 3 -->
                            <div class="timeline-step" id="step_update_ingredients"
                                onclick="showStepDetails('step_update_ingredients')">
                                <div class="timeline-marker"><i class="fa-solid fa-3"></i></div>
                                <div class="timeline-content">
                                    <h6 class="text-dark">Bileşen Güncelleme & Eşleştirme</h6>
                                    <p id="status_update_ingredients">Bekleniyor...</p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Toast Component -->
    <div class="toast-container position-fixed bottom-0 end-0 p-4">
        <div id="liveToast" class="toast align-items-center text-white bg-success border-0 shadow-lg" role="alert"
            aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body fs-6">
                    <i class="fa-solid fa-circle-check me-2"></i> <span id="toastBody">İşlem başarılı.</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem;">
                <div class="modal-header border-bottom-0 pb-0">
                    <h5 class="modal-title fw-bold text-dark ps-2">API İşlem Detayları</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body modal-body-details p-4">
                    <div class="row g-4 h-100">
                        <div class="col-md-6 h-100 d-flex flex-column">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill">Giden
                                    İstek (Payload)</span>
                                <i class="fa-solid fa-arrow-up-right-from-square text-muted"></i>
                            </div>
                            <pre class="json-view flex-grow-1 shadow-inner" id="modalPayload"></pre>
                        </div>
                        <div class="col-md-6 h-100 d-flex flex-column">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <span class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill">Gelen
                                    Cevap (Response)</span>
                                <i class="fa-solid fa-download text-muted"></i>
                            </div>
                            <pre class="json-view flex-grow-1 shadow-inner" id="modalResponse"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

    <script>
        // Global
        let allProducts = [];
        let tomSelectInstances = [];
        let createdReceteID = 0;
        let createdReceteKodu = "";

        // Logs for modal
        let stepLogs = {};

        const ROW_IDS = ['disFin', 'icFin', 'klad', 'kisa', 'uzun', 'yan'];
        const ROW_NAMES = ["DIŞ FİN", "İÇ FİN (DIŞ)", "KLAD ALM", "KISA KARE", "UZUN ÇUBUK", "YAN KUŞAK"];
        const API_TOKEN = 'pat_Wk9Q2PaNZiYm2mPdxLE1uZu5k4Mhvuj9GYg6n03XcoQ';

        // Data Groups
        const groups = {
            'default': { petekBoyu: 860, petekEni: 430, kalinlik: 115, icFin: 3, disFin: 10.3, almKlad: 0.6, sira: 30 },
            'group1': { petekBoyu: 900, petekEni: 450, kalinlik: 120, icFin: 3, disFin: 10.5, almKlad: 0.6, sira: 32 },
            'group2': { petekBoyu: 800, petekEni: 400, kalinlik: 100, icFin: 2.5, disFin: 10.0, almKlad: 0.5, sira: 28 },
            'group3': { petekBoyu: 1000, petekEni: 500, kalinlik: 140, icFin: 4, disFin: 11.0, almKlad: 0.8, sira: 35 }
        };

        const inputs = {
            petekBoyu: document.getElementById('petekBoyu'),
            petekEni: document.getElementById('petekEni'),
            kalinlik: document.getElementById('kalinlik'),
            icFin: document.getElementById('icFinKalinlik'),
            disFin: document.getElementById('disFinKalinlik'),
            almKlad: document.getElementById('almKladKalinlik'),
            sira: document.getElementById('siraSayisi'),
            sogutucu: document.getElementById('sogutucuAdedi')
        };

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            initTableStructure();
            calculate();
            fetchProducts();
        });

        // 1. Init Fixed Table Structure
        function initTableStructure() {
            const tbody = document.getElementById('resultsBody');
            let html = '';

            ROW_IDS.forEach((id, index) => {
                html += `
                    <tr>
                        <td class="fw-bold text-dark">${ROW_NAMES[index]}</td>
                        <td><span class="measure-badge" id="measure-${id}">-</span></td>
                        <td class="text-center fw-bold" id="qty-${id}">-</td>
                        <td>
                            <select id="select-${id}" class="form-select stock-select" placeholder="Ürün Ara...">
                                <option value="">Yükleniyor...</option>
                            </select>
                        </td>
                        <td class="text-muted small" id="note-${id}"></td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;

            ROW_IDS.forEach(id => {
                const el = document.getElementById(`select-${id}`);
                const ts = new TomSelect(el, {
                    create: false,
                    sortField: { field: "text", direction: "asc" },
                    placeholder: "Ürün seçiniz...",
                    render: {
                        option: function (data, escape) {
                            return '<div class="option"><span class="fw-bold text-primary">' + escape(data.text.split('-')[0]) + '</span> - ' + escape(data.text.split('-').slice(1).join('-')) + '</div>';
                        }
                    }
                });
                tomSelectInstances.push(ts);
            });
        }

        // 2. Fetch Products
        async function fetchProducts() {
            try {
                const response = await fetch('https://erp.aaro.com.tr/api/Stok?Etiket5Adi=uretim&SayfaSatirSayisi=500', {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error('API Error');

                const data = await response.json();
                if (data && data.Model) {
                    allProducts = data.Model;
                    updateDropdowns();
                }
            } catch (error) {
                console.error('Fetch error:', error);
                showToast("Ürün listesi yüklenemedi.", "error");
            }
        }

        function updateDropdowns() {
            // Include Code in Display
            const options = allProducts.map(p => ({
                value: p.StokID,
                text: `${p.StokKodu} - ${p.StokAdi}`
            }));

            tomSelectInstances.forEach(ts => {
                ts.clear();
                ts.clearOptions();
                ts.addOption(options);
                ts.refreshOptions(false);
            });
        }

        // 3. Calculation
        function calculate() {
            const petekBoyu = parseFloat(inputs.petekBoyu.value) || 0;
            const kalinlik = parseFloat(inputs.kalinlik.value) || 0;
            const icFin = parseFloat(inputs.icFin.value) || 0;
            const disFin = parseFloat(inputs.disFin.value) || 0;
            const almKlad = parseFloat(inputs.almKlad.value) || 0;
            const sira = parseFloat(inputs.sira.value) || 0;
            const sogutucu = parseFloat(inputs.sogutucu.value) || 0;

            // Yan Kuşak & Sabit Sayı
            const yanKusakKalinlik = kalinlik <= 63 ? 3 : 4;
            document.getElementById('resYanKusakKalinligi').innerText = yanKusakKalinlik + " mm";

            const sabitSayiInput = document.getElementById('resSabitSayi');
            const sabitSayiCalc = (icFin + disFin + (almKlad * 2)).toFixed(1);
            if (document.activeElement !== sabitSayiInput) {
                sabitSayiInput.value = sabitSayiCalc;
            }

            // Quantities
            const disFinAdet = sira * sogutucu;
            const icFinAdet = Math.round((petekBoyu / 300) * disFinAdet + 9);
            const commonAdet = (2 * disFinAdet) + 2;
            const yanKusakAdet = 2 * sogutucu;

            document.getElementById('resToplamParca').innerText = disFinAdet + icFinAdet + (commonAdet * 3) + yanKusakAdet;

            // Measurements & Logic mapping
            const measures = {
                'disFin': `${petekBoyu - 20} X ${kalinlik} X ${disFin}`,
                'icFin': `${kalinlik} X ${icFin}`,
                'klad': `${petekBoyu} X ${kalinlik} X ${almKlad}`,
                'kisa': `${kalinlik} X ${disFin}`,
                'uzun': `${petekBoyu} X ${icFin}`,
                'yan': `${petekBoyu} X ${kalinlik} X ${yanKusakKalinlik}`
            };

            const qties = {
                'disFin': disFinAdet,
                'icFin': icFinAdet,
                'klad': commonAdet,
                'kisa': commonAdet,
                'uzun': commonAdet,
                'yan': yanKusakAdet
            };

            const notes = {
                'klad': `${almKlad.toString().replace('.', ',')} KLAD`
            };

            ROW_IDS.forEach(id => {
                document.getElementById(`measure-${id}`).innerText = measures[id];
                document.getElementById(`qty-${id}`).innerText = qties[id];
                if (notes[id]) document.getElementById(`note-${id}`).innerText = notes[id];
            });
        }

        // 4. Integration Process
        async function startIntegrationProcess() {
            const btn = document.getElementById('startProcessBtn');
            const receteKodu = document.getElementById('receteKodu').value.trim();
            const receteAdi = document.getElementById('receteAdi').value.trim();

            if (!receteKodu || !receteAdi) {
                alert("Lütfen Reçete Kodu ve Adını giriniz.");
                return;
            }

            // Disable UI
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>';

            // Reset Logs
            stepLogs = {};

            try {
                // Step 1: Create Recipe
                await stepCreateRecipe(receteKodu, receteAdi);

                // Step 2: Fetch Ingredients of the created recipe
                const ingredients = await stepFetchIngredients(createdReceteID);

                // Step 3: Update Ingredients
                await stepUpdateIngredients(ingredients);

                showToast("Tüm işlemler başarıyla tamamlandı.");

            } catch (error) {
                console.error("Workflow Error:", error);
                alert("İşlem sırasında hata oluştu: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-play"></i>';
            }
        }

        async function stepCreateRecipe(code, name) {
            const stepId = 'step_recipe';
            updateStepStatus(stepId, 'active', 'İşleniyor...', 'fa-spinner fa-spin');

            const payload = {
                "ReceteID": 0,
                "ReceteKodu": code,
                "ReceteAdi": name,
                "Durum": true,
                "TipID": 101001,
                "DovizID": 1,
                "KaynakReceteID": 43,
                "KopyalaID": 43
            };

            try {
                const response = await fetch('https://erp.aaro.com.tr/api/UrRecete', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errText = await response.text();
                    logStep(stepId, payload, errText);
                    throw new Error(`API Hatası: ${response.status} - ${errText}`);
                }

                const result = await response.json();
                logStep(stepId, payload, result);

                if (result.Sonuc === true && result.Model) {
                    createdReceteID = result.Model.ReceteID;
                    createdReceteKodu = result.Model.ReceteKodu;
                    updateStepStatus(stepId, 'success', `Tamamlandı (ID: ${createdReceteID})`, 'fa-check');
                    return result;
                } else {
                    throw new Error(result.Mesajlar?.Mesaj || "Bilinmeyen API Hatası");
                }

            } catch (error) {
                updateStepStatus(stepId, 'error', 'Hata: ' + error.message, 'fa-xmark');
                throw error;
            }
        }

        async function stepFetchIngredients(receteId) {
            const stepId = 'step_fetch_ingredients';
            updateStepStatus(stepId, 'active', 'Veriler çekiliyor...', 'fa-spinner fa-spin');

            // As per user recent edit
            const url = `https://erp.aaro.com.tr/api/UrReceteOperasyonHammadde?Kisit.receteID=${receteId}&SayfaSatirSayisi=100&OperasyonKodu=000002,000001`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errText = await response.text();
                    logStep(stepId, { url: url }, errText);
                    throw new Error(`API Hatası (Fetch): ${response.status} - ${errText}`);
                }

                const result = await response.json();
                logStep(stepId, { url: url }, result);

                if (result.Model && Array.isArray(result.Model) && result.Model.length > 0) {
                    updateStepStatus(stepId, 'success', `${result.Model.length} Hammadde Bulundu`, 'fa-check');
                    return result.Model;
                } else {
                    updateStepStatus(stepId, 'success', 'Hammadde bulunamadı (0 adet)', 'fa-triangle-exclamation');
                    return [];
                }

            } catch (error) {
                updateStepStatus(stepId, 'error', 'Hata: ' + error.message, 'fa-xmark');
                throw error;
            }
        }

        async function stepUpdateIngredients(ingredients) {
            const stepId = 'step_update_ingredients';
            updateStepStatus(stepId, 'active', 'Güncellemeler yapılıyor...', 'fa-spinner fa-spin');

            const updatesLog = [];

            try {
                for (let i = 0; i < ROW_IDS.length; i++) {
                    const rowId = ROW_IDS[i];

                    if (i >= ingredients.length) {
                        break;
                    }

                    const originalData = ingredients[i];
                    const receteOpHammaddeID = originalData.ReceteOperasyonHammaddeID;

                    const dropdown = tomSelectInstances[i];
                    const selectedHammaddeID = dropdown.getValue();
                    const measureText = document.getElementById(`measure-${rowId}`).innerText;
                    const qtyText = document.getElementById(`qty-${rowId}`).innerText;

                    // If no product selected, we skip updating this row to avoid error, 
                    // or user might want to clear it. For now, skipping if empty.
                    if (!selectedHammaddeID) {
                        updatesLog.push({ row: ROW_NAMES[i], status: "Skipped (No Product)" });
                        continue;
                    }

                    const payload = { ...originalData };
                    payload.HammaddeID = parseInt(selectedHammaddeID);
                    payload.Miktar = parseFloat(qtyText) || 0;
                    payload.Aciklama = measureText;

                    const updateUrl = `https://erp.aaro.com.tr/api/UrReceteOperasyonHammadde/${receteOpHammaddeID}`;

                    const response = await fetch(updateUrl, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${API_TOKEN}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    const resText = await response.text();
                    let resJson;
                    try { resJson = JSON.parse(resText); } catch (e) { resJson = resText; }

                    updatesLog.push({
                        url: updateUrl,
                        payload: payload,
                        response: resJson
                    });

                    if (!response.ok) {
                        throw new Error(`Row ${i} Update Failed: ${response.status}`);
                    }
                }

                logStep(stepId, { info: "Bulk Update Log" }, updatesLog);
                updateStepStatus(stepId, 'success', 'Güncellemeler Tamamlandı', 'fa-check');

            } catch (error) {
                logStep(stepId, { partialLog: updatesLog }, error.message);
                updateStepStatus(stepId, 'error', 'Hata: ' + error.message, 'fa-xmark');
                throw error;
            }
        }

        function updateStepStatus(stepId, className, text, iconClass) {
            const el = document.getElementById(stepId);
            const statusEl = document.getElementById(`status_${stepId.replace('step_', '')}`);
            const marker = el.querySelector('.timeline-marker');

            el.classList.remove('active', 'success', 'error');
            if (className) el.classList.add(className);

            if (statusEl) statusEl.innerText = text;
            if (marker && iconClass) marker.innerHTML = `<i class="fa-solid ${iconClass}"></i>`;
        }

        function logStep(stepId, req, res) {
            stepLogs[stepId] = { request: req, response: res };
        }

        function showStepDetails(stepId) {
            if (!stepLogs[stepId]) return;
            const log = stepLogs[stepId];
            document.getElementById('modalPayload').innerHTML = syntaxHighlight(log.request);
            document.getElementById('modalResponse').innerHTML = syntaxHighlight(log.response);
            new bootstrap.Modal(document.getElementById('detailsModal')).show();
        }

        function syntaxHighlight(json) {
            if (typeof json != 'string') {
                json = JSON.stringify(json, undefined, 2);
            }
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                var cls = 'number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'key';
                    } else {
                        cls = 'string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'boolean';
                } else if (/null/.test(match)) {
                    cls = 'null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        function showToast(msg, type = 'success') {
            const toastEl = document.getElementById('liveToast');
            document.getElementById('toastBody').innerText = msg;

            if (type === 'error') {
                toastEl.classList.remove('bg-success');
                toastEl.classList.add('bg-danger');
            } else {
                toastEl.classList.remove('bg-danger');
                toastEl.classList.add('bg-success');
            }

            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        // Group Handler
        document.getElementById('productGroup').addEventListener('change', (e) => {
            const val = e.target.value;
            if (groups[val]) {
                const g = groups[val];
                inputs.petekBoyu.value = g.petekBoyu;
                inputs.petekEni.value = g.petekEni;
                inputs.kalinlik.value = g.kalinlik;
                inputs.icFin.value = g.icFin;
                inputs.disFin.value = g.disFin;
                inputs.almKlad.value = g.almKlad;
                inputs.sira.value = g.sira;
                calculate();
            }
        });

        // Input Listeners
        Object.values(inputs).forEach(input => {
            input.addEventListener('input', calculate);
        });

    </script>
</body>

</html>