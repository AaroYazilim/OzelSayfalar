<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verilen Teklif Raporu</title>

    <!-- Gerekli CDN'ler -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap4.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script class="AaroOnTanimGecici">
        var Aaro = {
            "SayfaKodu": "PersonelPuantajRaporu",
            "SayfaAdi": "Personel Puantaj Raporu",
            "AnaUrl": "https://localhost:44346/",
            "Tarih": "2025-09-22 14:26:41",
            "IsAuthenticated": "True",
            "UserIP": "127.0.0.1",
            "Oturum": {
                "KullaniciKodu": "yonetici@temel",
                "KullaniciAdi": "A Kullanicisi",
                "KullaniciID": "2",
                "GrupAdi": "Temel",
                "SirketID": "0",
                "SubeID": "0",
                "SirketAdi": "Tüm Şirketler",
                "SubeAdi": "Tüm Şubeler",
                "KullaniciGrupID": "2",
                "KullaniciGrupKodu": "YNTC",
                "KullaniciGrupAdi": "Yönetici Grubu",
                "Token": ":)"
            },
            "QueryString": {},
            "Form": {}
        }
    </script>
    <!-- Modern Tema ve Özel Stiller -->
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
        }

        .card {
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            background-color: var(--card-background);
        }
        
        .nav-tabs {
            border-bottom: 1px solid var(--border-color);
        }

        .nav-tabs .nav-link {
            border: 0;
            color: var(--text-secondary);
            font-weight: 600;
            padding: 0.75rem 1rem;
            margin-bottom: -1px;
            border-bottom: 2px solid transparent;
        }

        .nav-tabs .nav-link:hover {
            border-color: var(--border-color);
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: transparent;
            border-bottom-color: var(--primary-color);
        }

        #teklifTable thead th {
            background-color: #f8fafc;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom-width: 1px;
        }

        /* İskelet Yükleyici Stilleri */
        .skeleton-row td .skeleton-cell {
            height: 20px;
            width: 85%;
            background-color: #e2e8f0; /* Renk border-color'dan farklı olsun */
            border-radius: 4px;
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            50% { opacity: .5; }
        }

        /* DataTables Filtre ve Buton Stilleri */
        #teklifTable_filter input,
        #teklifTable tfoot input,
        #teklifTable tfoot select {
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
        }
        .dt-buttons .btn {
            background-color: var(--primary-color);
            color: white;
            border-radius: 0.375rem;
        }
        .dt-buttons .btn:hover {
            background-color: var(--primary-hover);
        }

        /* Grafik Alanı Düzeltmesi */
        .chart-container {
            position: relative;
            height: 40vh; /* Sabit yükseklik */
            min-height: 300px;
            width: 100%;
        }

        /* JSON Görüntüleyici Stili */
        #jsonDataViewer {
            background-color: #f8fafc;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 60vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid my-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0" style="font-weight: 700; color: var(--text-primary);">Verilen Teklif Raporu</h2>
        </div>

        <div class="card">
            <div class="card-body">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active" id="tablo-tab" data-toggle="tab" href="#tablo" role="tab" aria-controls="tablo" aria-selected="true"><i class="fas fa-table mr-2"></i>Teklif Listesi</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="grafik-tab" data-toggle="tab" href="#grafik" role="tab" aria-controls="grafik" aria-selected="false"><i class="fas fa-chart-pie mr-2"></i>Grafiksel Rapor</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="json-tab" data-toggle="tab" href="#json" role="tab" aria-controls="json" aria-selected="false"><i class="fas fa-code mr-2"></i>JSON Veri</a>
                    </li>
                </ul>

                <div class="tab-content pt-4" id="myTabContent">
                    <div class="tab-pane fade show active" id="tablo" role="tabpanel" aria-labelledby="tablo-tab">
                         <table id="teklifTable" class="table table-hover" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Teklif No</th>
                                    <th>Müşteri</th>
                                    <th>Açıklama</th>
                                    <th>Son Teklif Tarihi</th>
                                    <th>Verilen Tarih</th>
                                    <th>Zamanlama</th>
                                    <th>Durum</th>
                                    <th>Sebep</th>
                                    <th>Müşteri Tipi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- İskelet yükleyici veya veriler buraya gelecek -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th>Teklif No</th>
                                    <th>Müşteri</th>
                                    <th>Açıklama</th>
                                    <th>Son Teklif Tarihi</th>
                                    <th>Verilen Tarih</th>
                                    <th>Zamanlama</th>
                                    <th>Durum</th>
                                    <th>Sebep</th>
                                    <th>Müşteri Tipi</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="grafik" role="tabpanel" aria-labelledby="grafik-tab">
                        <div id="grafik-alani" class="pt-3">
                            <div class="alert alert-light text-center">Filtrelenmiş verilere ait grafikler burada gösterilecektir.</div>
                             <div class="row">
                                <div class="col-lg-6 mb-4 mb-lg-0">
                                    <div class="card h-100">
                                        <div class="card-body d-flex flex-column justify-content-center">
                                            <h5 class="text-center text-secondary mb-3">Teklif Durum Dağılımı</h5>
                                            <div class="chart-container">
                                                <canvas id="durumChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                     <div class="card h-100">
                                        <div class="card-body d-flex flex-column justify-content-center">
                                            <h5 class="text-center text-secondary mb-3">Teklif Zamanlama Durumu</h5>
                                             <div class="chart-container">
                                                <canvas id="zamanlamaChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div class="tab-pane fade" id="json" role="tabpanel" aria-labelledby="json-tab">
                        <pre id="jsonDataViewer">Veriler yüklendiğinde burada görünecektir...</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JS Kütüphaneleri -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap4.min.js"></script>

    <script>
        // Global değişkenler
        const bearerToken = '@token';
        const endpoint = 'https://erp.aaro.com.tr/api/VerilenTeklifListe';
        let dataTableInstance;
        let durumChartInstance;
        let zamanlamaChartInstance;
        let rawApiData = []; // Ham veriyi saklamak için

        function parseDate(dateStr) {
            if (!dateStr || typeof dateStr !== 'string') return null;
            const cleanedDateStr = dateStr.split('T')[0];
            let dateObj;
            if (/^\d{4}[-\/\.]\d{1,2}[-\/\.]\d{1,2}$/.test(cleanedDateStr)) {
                dateObj = new Date(cleanedDateStr.replace(/[\/\.]/g, '-'));
            } else if (/^\d{1,2}[-\/\.]\d{1,2}[-\/\.]\d{4}$/.test(cleanedDateStr)) {
                const parts = cleanedDateStr.split(/[-\/\.]/);
                dateObj = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
            } else { return null; }
            return isNaN(dateObj.getTime()) ? null : dateObj;
        }
        
        function formatDate(dateObj) {
            if (!dateObj || !(dateObj instanceof Date)) return '';
            return dateObj.toISOString().split('T')[0];
        }

        function fetchAllPaginatedData(options) {
            return new Promise((resolve, reject) => {
                const settings = $.extend(true, {}, {
                    method: 'GET', initialParams: {}, rateLimitDelay: 200, pagination: {
                        pageParamName: 'Sayfa', pageSizeParamName: 'SayfaSatirSayisi', pageSize: 1000,
                        getDataArray: (r) => r.Model, getPaginationInfo: (r) => r.SayfalandirmaBilgisi, hasNextPage: (p) => p.SonrakiSayfaVarMi,
                    },
                }, options);

                if (!settings.endpoint || !settings.bearerToken) return reject("Endpoint ve Bearer Token zorunludur.");
                let allData = [];
                function fetchPage(pageNumber) {
                    const requestData = $.extend({}, settings.initialParams);
                    requestData[settings.pagination.pageParamName] = pageNumber;
                    requestData[settings.pagination.pageSizeParamName] = settings.pagination.pageSize;

                    $.ajax({
                        url: settings.endpoint, method: settings.method,
                        headers: { 'Accept': 'application/json', 'Authorization': 'Bearer ' + bearerToken },
                        data: requestData
                    }).done(function(response) {
                        try {
                            const dataArray = settings.pagination.getDataArray(response);
                            const pInfo = settings.pagination.getPaginationInfo(response);
                            if (!response || !dataArray || !pInfo) return reject("API yanıtı beklenilen formatta değil.");
                            allData = allData.concat(dataArray);
                            const totalItems = pInfo.ToplamSatirSayisi || 0;
                            if (settings.pagination.hasNextPage(pInfo) && dataArray.length > 0 && allData.length < totalItems) {
                                setTimeout(() => fetchPage(pageNumber + 1), settings.rateLimitDelay);
                            } else { resolve(allData); }
                        } catch (e) { reject(e); }
                    }).fail((jqXHR) => reject(jqXHR));
                }
                fetchPage(1);
            });
        }
        
        function updateUI(data) {
             initDataTable(data);
             updateCharts(data);
             updateJsonViewer(data);
            if(dataTableInstance){
                dataTableInstance.on('draw.dt', function () {
                    const filteredData = dataTableInstance.rows({ filter: 'applied' }).data().toArray().map(d => d.source);
                    updateCharts(filteredData);
                    updateJsonViewer(filteredData);
                });
            }
        }
        
        function initDataTable(data) {
            const processedData = data.map(item => {
                const sonTeklifTarihi = parseDate(item.Aciklama1);
                const verilenTarih = parseDate(item.Tarih);
                let vermeZamani = 'Bilinmiyor';
                if(sonTeklifTarihi && verilenTarih){
                    vermeZamani = verilenTarih <= sonTeklifTarihi ? 'Başarılı' : 'Başarısız';
                }
                return {
                    "Teklif No": item.BelgeNo || '', "Müşteri": item.KartAdi || '', "Açıklama": item.Aciklama || '',
                    "Son Teklif Tarihi": formatDate(sonTeklifTarihi), "Verilen Tarih": formatDate(verilenTarih),
                    "Zamanlama": vermeZamani, "Durum": item.Etiket2Adi || 'Belirtilmemiş', "Sebep": item.Etiket3Adi || '',
                    "Müşteri Tipi": item.Etiket1Adi || 'Belirtilmemiş', "source": item
                };
            });

            if(dataTableInstance) dataTableInstance.destroy();
            $('#teklifTable tfoot th').empty();

            dataTableInstance = $('#teklifTable').DataTable({
                data: processedData,
                columns: [
                    { data: 'Teklif No' }, { data: 'Müşteri' }, { data: 'Açıklama' }, { data: 'Son Teklif Tarihi' },
                    { data: 'Verilen Tarih' }, { data: 'Zamanlama', render: function (data) {
                        const badgeClass = data === 'Başarılı' ? 'badge-success' : (data === 'Başarısız' ? 'badge-danger' : 'badge-secondary');
                        return `<span class="badge ${badgeClass}">${data}</span>`;
                    } },
                    { data: 'Durum' }, { data: 'Sebep' }, { data: 'Müşteri Tipi' }
                ],
                responsive: true,
                language: { url: "//cdn.datatables.net/plug-ins/1.10.25/i18n/Turkish.json", "emptyTable": "Gösterilecek veri bulunamadı." },
                dom: "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" + "<'row'<'col-sm-12'tr>>" + "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
                initComplete: function () {
                    this.api().columns().every(function () {
                        var column = this; var title = $(column.header()).text(); var footer = $(column.footer());
                        if (!footer.length) return;
                        if (['Zamanlama', 'Durum', 'Müşteri Tipi'].includes(title)) {
                             var select = $('<select class="form-control form-control-sm"><option value="">Tümü</option></select>')
                                .appendTo(footer.empty()).on('change', function () {
                                    var val = $.fn.dataTable.util.escapeRegex($(this).val());
                                    column.search(val ? '^' + val + '$' : '', true, false).draw();
                                });
                            column.data().unique().sort().each(function (d, j) {
                                var text = d.includes('badge') ? $(d).text() : d;
                                if(select.find('option[value="' + text + '"]').length === 0) select.append('<option value="' + text + '">' + text + '</option>')
                            });
                        } else {
                            $('<input type="text" class="form-control form-control-sm" placeholder="' + title + ' Ara" />')
                                .appendTo(footer.empty()).on('keyup change clear', function () { if (column.search() !== this.value) column.search(this.value).draw(); });
                        }
                    });
                }
            });
        }
        
        function updateCharts(data) {
            $('#grafik-alani .alert').hide();
            const durumCounts = data.reduce((acc, item) => {
                const durum = item.Etiket2Adi || 'Belirtilmemiş'; acc[durum] = (acc[durum] || 0) + 1; return acc;
            }, {});
            if(durumChartInstance) durumChartInstance.destroy();
            durumChartInstance = new Chart(document.getElementById('durumChart'), { type: 'pie', data: { labels: Object.keys(durumCounts), datasets: [{ data: Object.values(durumCounts), backgroundColor: ['#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6c757d', '#4f46e5'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, legend: { position: 'bottom' } } });
            
            const zamanlamaCounts = data.reduce((acc, item) => {
                const son = parseDate(item.Aciklama1); const verilen = parseDate(item.Tarih);
                let durum = 'Bilinmiyor'; if (son && verilen) durum = verilen <= son ? 'Başarılı' : 'Başarısız';
                acc[durum] = (acc[durum] || 0) + 1; return acc;
            }, {});
            if(zamanlamaChartInstance) zamanlamaChartInstance.destroy();
            zamanlamaChartInstance = new Chart(document.getElementById('zamanlamaChart'), { type: 'doughnut', data: { labels: Object.keys(zamanlamaCounts), datasets: [{ data: Object.values(zamanlamaCounts), backgroundColor: ['#28a745', '#dc3545', '#6c757d'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, legend: { position: 'bottom' } } });
        }

        function updateJsonViewer(data) {
            const viewer = document.getElementById('jsonDataViewer');
            if (viewer) {
                viewer.textContent = JSON.stringify(data, null, 2);
            }
        }

        function showSkeletonLoader(rowCount = 10) {
            const tableBody = $('#teklifTable tbody');
            tableBody.empty();
            const columnCount = $('#teklifTable thead th').length;
            let skeletonHtml = '';
            for (let i = 0; i < rowCount; i++) {
                skeletonHtml += '<tr class="skeleton-row">';
                for (let j = 0; j < columnCount; j++) skeletonHtml += '<td><div class="skeleton-cell mx-auto"></div></td>';
                skeletonHtml += '</tr>';
            }
            tableBody.html(skeletonHtml);
        }

        $(document).ready(function() {
            showSkeletonLoader();
            fetchAllPaginatedData({ bearerToken: bearerToken, endpoint: endpoint })
            .then(data => {
                rawApiData = data || []; // Ham veriyi sakla
                updateUI(rawApiData);
            })
            .catch(error => {
                $('#teklifTable tbody').empty();
                console.error("Veri çekme hatası:", error);
                Swal.fire({
                    icon: 'error', title: 'Hata!',
                    text: 'API\'den veri çekilirken bir sorun oluştu.',
                    footer: `Detay: ${error.statusText || 'Bilinmeyen hata'}`
                });
            });
        });
    </script>
</body>
</html>

