<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aaro - Hızlı Cari Oluşturma</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }

        .wizard-step-active {
            @apply scale-110 shadow-lg ring-4 ring-blue-100 bg-blue-600;
        }

        .wizard-step-done {
            @apply bg-emerald-500 scale-100;
        }

        .wizard-step-pending {
            @apply bg-gray-300;
        }

        [v-cloak] {
            display: none;
        }

        .transition-all {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f8fafc;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }
    </style>
</head>

<body class="bg-[#f8fafc] text-slate-800 min-h-screen">

    <div id="app" v-cloak class="max-w-[1400px] mx-auto px-4 py-6">
        <!-- Persistent Loading Overlay for heavy CPU tasks -->
        <transition name="fade">
            <div v-if="isFileLoading"
                class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[100] flex items-center justify-center">
                <div class="bg-white p-8 rounded-[2rem] shadow-2xl text-center space-y-4">
                    <div
                        class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto">
                    </div>
                    <h4 class="text-xl font-bold text-slate-900">İşlem Yapılıyor</h4>
                    <p class="text-slate-500 text-sm">Lütfen bekleyin, veriler işleniyor...</p>
                </div>
            </div>
        </transition>

        <!-- Top Navigation / Header -->
        <nav class="flex justify-between items-center mb-10 bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-blue-200 shadow-lg">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 4.354l1.103 3.39h3.562l-2.882 2.094 1.103 3.39L12 11.13l-2.882 2.098 1.103-3.39-2.882-2.094h3.562L12 4.354z">
                        </path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-slate-900">Aaro Cari Sihirbazı</h1>
                    <p class="text-[11px] text-slate-500 font-medium uppercase tracking-widest">Aaro API Integration
                        Suite</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button @click="resetApp"
                    class="px-5 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50 rounded-xl transition-all border border-slate-200">
                    Sıfırla
                </button>
            </div>
        </nav>

        <!-- Stepper (Visual Progression) -->
        <div class="mb-12 max-w-3xl mx-auto">
            <div class="flex items-center justify-between relative px-2">
                <div class="absolute left-0 top-5 w-full h-0.5 bg-slate-200 -z-10"></div>
                <div class="absolute left-0 top-5 h-0.5 bg-blue-500 -z-10 transition-all duration-500"
                    :style="{ width: (currentStep * 50) + '%' }"></div>

                <div v-for="(step, index) in steps" :key="index" class="flex flex-col items-center">
                    <div :class="[
                    'w-10 h-10 rounded-full flex items-center justify-center font-bold text-white transition-all duration-500 z-10',
                    currentStep > index ? 'wizard-step-done' : (currentStep === index ? 'wizard-step-active' : 'wizard-step-pending')
                ]">
                        <svg v-if="currentStep > index" class="w-6 h-6" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7">
                            </path>
                        </svg>
                        <span v-else>{{ index + 1 }}</span>
                    </div>
                    <span
                        :class="['mt-3 text-xs font-bold uppercase tracking-wider', currentStep >= index ? 'text-blue-600' : 'text-slate-400']">{{
                        step }}</span>
                </div>
            </div>
        </div>

        <!-- Step 1: File Selection -->
        <transition name="fade" mode="out-in">
            <div v-if="currentStep === 0" class="max-w-4xl mx-auto">
                <div
                    class="bg-white rounded-3xl shadow-xl shadow-slate-200/50 p-12 border border-slate-100 text-center">
                    <div class="mb-8 relative inline-block">
                        <div class="w-24 h-24 bg-blue-50 rounded-3xl flex items-center justify-center mx-auto transition-all hover:scale-110 hover:bg-blue-100 cursor-pointer"
                            @click="$refs.fileInput.click()">
                            <svg class="w-12 h-12 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                </path>
                            </svg>
                        </div>
                    </div>
                    <h3 class="text-3xl font-bold text-slate-900 mb-4">Müşteri Listenizi Yükleyin</h3>
                    <p class="text-slate-500 max-w-md mx-auto mb-10 leading-relaxed">Excel veya CSV formatındaki müşteri
                        listenizi sürükleyip bırakın. Sistem otomatik olarak sütunları tanıyacak ve sizi
                        yönlendirecektir.</p>

                    <div class="flex flex-col items-center gap-4">
                        <input type="file" ref="fileInput" class="hidden" accept=".xlsx, .xls, .csv"
                            @change="handleFileUpload">
                        <button @click="$refs.fileInput.click()"
                            class="bg-blue-600 text-white px-10 py-4 rounded-2xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 hover:scale-[1.02] transition-all flex items-center gap-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                            </svg>
                            Excel Dosyası Seçin
                        </button>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-4">Veya dosyayı
                            buraya sürükleyin</p>
                    </div>

                    <div class="grid grid-cols-3 gap-6 mt-16 border-t border-slate-50 pt-10">
                        <div class="text-left">
                            <div class="text-blue-600 font-bold mb-1">1. Yükle</div>
                            <p class="text-xs text-slate-400">Dosyanızı sisteme tanıtın.</p>
                        </div>
                        <div class="text-left">
                            <div class="text-indigo-600 font-bold mb-1">2. Düzenle</div>
                            <p class="text-xs text-slate-400">Verileri kontrol edin ve eşleştirin.</p>
                        </div>
                        <div class="text-left">
                            <div class="text-emerald-600 font-bold mb-1">3. Tamamla</div>
                            <p class="text-xs text-slate-400">API üzerinden carileri oluşturun.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Editor & Mapping -->
            <div v-else-if="currentStep === 1" class="space-y-6">
                <div class="flex flex-col xl:flex-row gap-6">
                    <!-- Left Sidebar: Settings & Mapping -->
                    <div class="xl:w-[380px] space-y-6 shrink-0">
                        <!-- Wizard Progress / Guide -->
                        <div class="bg-blue-600 rounded-3xl p-6 text-white shadow-xl shadow-blue-200">
                            <h4 class="font-bold mb-2 flex items-center gap-2">
                                <span class="bg-white/20 p-1 rounded-lg"><svg class="w-4 h-4" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg></span>
                                Adım Rehberi
                            </h4>
                            <p class="text-xs text-blue-100 leading-relaxed">
                                Aşağıdaki zorunlu alanları (Kırmızı) Excel sütunlarınız ile eşleştirin. Verilerinizde
                                hata varsa yan paneldeki <b>Toplu İşlemler</b> kısmını kullanabilirsiniz.
                            </p>

                            <div class="mt-6 pt-6 border-t border-white/10 space-y-4">
                                <div class="flex justify-between text-xs font-bold">
                                    <span>Zorunlu Alan Eşleşmesi</span>
                                    <span>{{ mappedRequiredCount }} / {{ requiredCount }}</span>
                                </div>
                                <div class="w-full bg-white/20 h-1.5 rounded-full overflow-hidden">
                                    <div class="bg-white h-full transition-all duration-500"
                                        :style="{ width: (mappedRequiredCount/requiredCount * 100) + '%' }"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Header Row Setting -->
                        <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Veri
                                Başlangıç Satırı</label>
                            <div class="flex items-center gap-4">
                                <input type="number" v-model.number="headerRowIndex" min="1"
                                    class="w-20 bg-slate-50 border-none rounded-xl px-4 py-3 font-bold text-blue-600 focus:ring-2 focus:ring-blue-500 transition-all">
                                <span class="text-sm text-slate-500 font-medium">. satır başlıkları içeriyor.</span>
                            </div>
                        </div>

                        <!-- Mapping Accordion -->
                        <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                            <div class="p-6 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                                <h4 class="font-bold text-slate-800 flex items-center gap-2 cursor-pointer"
                                    @click="showMapping = !showMapping">
                                    <svg class="w-4 h-4 transition-transform" :class="{'rotate-180': !showMapping}"
                                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                    Alan Eşleştirme
                                </h4>
                                <span
                                    class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-bold uppercase">{{
                                    Object.keys(apiMap).length }} Alan</span>
                            </div>

                            <div v-show="showMapping" class="p-6 space-y-5 max-h-[500px] overflow-y-auto">
                                <div v-for="(field, key) in apiMap" :key="key" class="space-y-1.5 group">
                                    <label class="flex justify-between items-center group-hover:px-1 transition-all">
                                        <span class="text-[11px] font-bold text-slate-500 uppercase tracking-wide">{{
                                            field.label }}</span>
                                        <span v-if="field.required"
                                            class="text-[9px] font-black text-red-500 uppercase bg-red-50 px-1.5 py-0.5 rounded">ZORUNLU</span>
                                    </label>
                                    <select v-model="field.column"
                                        :class="{'ring-2 ring-red-100 border-red-200': field.required && !field.column, 'border-slate-200': !field.required || field.column}"
                                        class="w-full bg-slate-50 border-2 rounded-xl px-4 py-2.5 text-sm font-semibold focus:bg-white focus:border-blue-500 transition-all outline-none appearance-none">
                                        <option :value="null">-- Sütun Seçin --</option>
                                        <option v-for="col in columns" :key="col" :value="col">{{ col }}</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Section: Preview & Bulk Edit -->
                    <div class="flex-1 space-y-6 min-w-0">
                        <!-- Bulk Edit Tools -->
                        <div
                            class="bg-white rounded-[2rem] p-6 shadow-md border border-slate-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-8 opacity-[0.03] pointer-events-none">
                                <svg class="w-32 h-32" fill="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7l-2 2v5H4V6h5l2-2zM20.3 3.3a1 1 0 0 1 1.4 1.4l-11 11a1 1 0 0 1-.4.3l-5 2a1 1 0 0 1-1.3-1.3l2-5a1 1 0 0 1 .3-.4l11-11z">
                                    </path>
                                </svg>
                            </div>

                            <div class="flex items-center gap-3 mb-6">
                                <h3 class="text-xl font-bold text-slate-900">Toplu İşlemler</h3>
                                <span
                                    class="text-[10px] bg-amber-50 text-amber-600 px-3 py-1 rounded-full font-bold uppercase tracking-widest border border-amber-100">Veriyi
                                    Temizle</span>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                <div class="space-y-1.5">
                                    <label class="text-[11px] font-bold text-slate-400 uppercase px-1">Seçili
                                        Sütun</label>
                                    <select v-model="bulkEdit.column"
                                        class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl px-4 py-3 text-sm font-bold focus:bg-white transition-all outline-none">
                                        <option :value="null">-- Tüm Tablo --</option>
                                        <option v-for="col in columns" :key="col" :value="col">{{ col }}</option>
                                    </select>
                                </div>
                                <div class="space-y-1.5">
                                    <label class="text-[11px] font-bold text-slate-400 uppercase px-1">İşlem
                                        Tipi</label>
                                    <select v-model="bulkEdit.mode"
                                        class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl px-4 py-3 text-sm font-bold focus:bg-white transition-all outline-none">
                                        <option value="replace">Bul ve Değiştir</option>
                                        <option value="set">Sabit Değer Ata</option>
                                    </select>
                                </div>
                                <div v-if="bulkEdit.mode === 'replace'" class="space-y-1.5">
                                    <label class="text-[11px] font-bold text-slate-400 uppercase px-1">Şunu Bul</label>
                                    <input type="text" v-model="bulkEdit.find"
                                        class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl px-4 py-3 text-sm font-bold focus:bg-white transition-all outline-none"
                                        placeholder="Aranan...">
                                </div>
                                <div class="space-y-1.5">
                                    <label class="text-[11px] font-bold text-slate-400 uppercase px-1">{{ bulkEdit.mode
                                        === 'replace' ? 'Yeni Değer' : 'Atanacak Değer' }}</label>
                                    <input type="text" v-model="bulkEdit.replace"
                                        class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl px-4 py-3 text-sm font-bold focus:bg-white transition-all outline-none"
                                        placeholder="Yeni Veri...">
                                </div>
                            </div>

                            <div class="flex justify-end mt-6">
                                <button @click="applyBulkEdit" :disabled="!bulkEdit.column && bulkEdit.mode === 'set'"
                                    class="bg-slate-900 text-white px-8 py-3 rounded-xl font-bold text-sm shadow-xl shadow-slate-200 hover:bg-slate-800 disabled:opacity-30 disabled:cursor-not-allowed transition-all flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                    Değişiklikleri Uygula
                                </button>
                            </div>
                        </div>

                        <!-- Data Table Preview -->
                        <div
                            class="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden flex flex-col h-[600px]">
                            <div
                                class="px-8 py-5 border-b border-slate-50 bg-slate-50/50 flex justify-between items-center">
                                <h3 class="font-bold text-slate-800 tracking-tight">Veri Tablosu</h3>
                                <button @click="currentStep++" :disabled="mappedRequiredCount < requiredCount"
                                    class="bg-blue-600 text-white px-8 py-3 rounded-2xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 disabled:opacity-40 disabled:cursor-wait transition-all flex items-center gap-2">
                                    Devam Et
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                                    </svg>
                                </button>
                            </div>

                            <div class="overflow-auto flex-1">
                                <table class="w-full text-sm text-left border-collapse">
                                    <thead class="sticky top-0 z-20 shadow-sm">
                                        <tr class="bg-white">
                                            <th
                                                class="px-6 py-4 font-bold text-[10px] text-slate-400 uppercase tracking-widest border-b border-slate-100">
                                                #</th>
                                            <th v-for="col in columns" :key="col"
                                                class="px-6 py-4 font-bold text-[10px] text-slate-600 uppercase tracking-widest border-b border-slate-100 border-l border-slate-50 min-w-[200px]">
                                                <div class="flex flex-col gap-1">
                                                    <span>{{ col }}</span>
                                                    <span v-if="getMappedField(col)"
                                                        class="text-[9px] text-white bg-blue-500 px-2 py-0.5 rounded-full inline-block w-fit font-bold italic">
                                                        ➜ {{ getMappedField(col) }}
                                                    </span>
                                                </div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        <tr v-for="(row, idx) in previewRows" :key="idx"
                                            class="hover:bg-slate-50 group transition-all">
                                            <td class="px-6 py-3 font-mono text-[10px] text-slate-300 bg-slate-50/30">{{
                                                idx + 1 }}</td>
                                            <td v-for="col in columns" :key="col"
                                                class="px-6 py-3 text-slate-600 font-medium border-l border-slate-50/50">
                                                <input type="text" v-model="row[col]"
                                                    class="w-full bg-transparent border-none p-0 focus:ring-0 text-sm hover:text-blue-600 transition-colors">
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div
                                class="px-8 py-3 bg-slate-50 text-[10px] font-bold text-slate-400 text-right uppercase tracking-widest">
                                Tablo üzerinde doğrudan düzenleme yapabilirsiniz.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Action & Logs -->
            <div v-else-if="currentStep === 2" class="max-w-4xl mx-auto space-y-6">
                <div
                    class="bg-white rounded-[2.5rem] p-10 shadow-2xl shadow-slate-200/50 border border-slate-100 text-center relative overflow-hidden">
                    <div class="relative z-10">
                        <h3 class="text-2xl font-bold text-slate-800 mb-2">İşlem Kuyruğu</h3>
                        <p class="text-slate-400 text-sm mb-10">Verileriniz Aaro API üzerinden Cari kartlarına
                            dönüştürülüyor.</p>

                        <div class="flex justify-center gap-12 mb-12">
                            <div class="text-center">
                                <div class="text-4xl font-extrabold text-slate-900 leading-none">{{ completedCount }}
                                </div>
                                <div class="text-[10px] font-black text-slate-400 uppercase mt-2 tracking-widest">
                                    Tamamlanan</div>
                            </div>
                            <div class="w-px h-12 bg-slate-100"></div>
                            <div class="text-center">
                                <div class="text-4xl font-extrabold text-blue-600 leading-none">{{ progressPercentage
                                    }}%</div>
                                <div class="text-[10px] font-black text-slate-400 uppercase mt-2 tracking-widest">
                                    İlerleme</div>
                            </div>
                            <div class="w-px h-12 bg-slate-100"></div>
                            <div class="text-center">
                                <div class="text-4xl font-extrabold text-slate-900 leading-none">{{ totalCount }}</div>
                                <div class="text-[10px] font-black text-slate-400 uppercase mt-2 tracking-widest">Kuyruk
                                </div>
                            </div>
                        </div>

                        <div
                            class="w-full bg-slate-100 h-6 rounded-3xl mb-12 p-1 relative overflow-hidden ring-1 ring-slate-100 shadow-inner">
                            <div class="h-full bg-blue-600 rounded-2xl shadow-lg transition-all duration-300 relative overflow-hidden"
                                :style="{ width: progressPercentage + '%' }">
                                <div class="absolute inset-0 bg-white/20 w-full animate-[shimmer_2s_infinite]"></div>
                            </div>
                        </div>

                        <div class="flex justify-center gap-4">
                            <button v-if="!isProcessing && remainingCount > 0" @click="currentStep--"
                                class="bg-slate-100 text-slate-600 px-8 py-4 rounded-2xl font-bold hover:bg-slate-200 transition-all flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                </svg>
                                Düzenlemeye Dön
                            </button>
                            <button v-if="!isProcessing && remainingCount > 0" @click="startProcessing"
                                class="bg-blue-600 text-white px-12 py-4 rounded-2xl font-bold shadow-xl shadow-blue-200 hover:bg-blue-700 hover:scale-105 transition-all flex items-center gap-3">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z">
                                    </path>
                                </svg>
                                Süreci Başlat
                            </button>
                            <button v-if="isProcessing" @click="stopProcessing"
                                class="bg-rose-500 text-white px-12 py-4 rounded-2xl font-bold shadow-xl shadow-rose-100 hover:bg-rose-600 transition-all flex items-center gap-3">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                İşlemi Durdur
                            </button>
                            <button v-if="completedCount === totalCount && totalCount > 0" @click="downloadReport"
                                class="bg-slate-900 text-white px-12 py-4 rounded-2xl font-bold hover:bg-black transition-all">
                                Raporu İndir (.xlsx)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Terminal / Logs -->
                <div class="bg-slate-900 rounded-[2rem] shadow-2xl p-1 overflow-hidden">
                    <div class="bg-slate-800/50 px-6 py-3 border-b border-slate-700 flex justify-between items-center">
                        <div class="flex gap-1.5 items-center">
                            <div class="w-2.5 h-2.5 rounded-full bg-emerald-500 animate-pulse"></div>
                            <span
                                class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest font-mono">Live
                                Logs</span>
                        </div>
                        <div class="flex gap-4">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Başarılı: <span
                                    class="text-emerald-400">{{ successCount }}</span></span>
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Hata: <span
                                    class="text-rose-400">{{ errorCount }}</span></span>
                        </div>
                    </div>
                    <div class="p-6 font-mono text-xs text-slate-300 h-[400px] overflow-auto space-y-1"
                        id="log-monitor">
                        <div v-for="(log, idx) in logs" :key="idx" :class="getLogClass(log.type)"
                            class="border-l border-slate-700 pl-4 py-0.5">
                            <span class="text-slate-600 mr-2 opacity-50">{{ log.time }}</span>
                            <span v-if="log.row" class="text-indigo-400 font-bold mr-2">Line:{{ log.row }}</span>
                            <span v-html="log.msg"></span>
                        </div>
                        <div v-if="logs.length === 0"
                            class="h-full flex items-center justify-center italic text-slate-600">Henüz bir işlem
                            gerçekleştirilmedi...</div>
                    </div>
                </div>
            </div>
        </transition>
    </div>

    <script>
        const { createApp, ref, computed, watch, reactive, nextTick } = Vue;

        createApp({
            setup() {
                // General UI State
                const steps = ['Veri Yükleme', 'Düzenleme & Eşleştirme', 'İşlem Kuyruğu'];
                const currentStep = ref(0);
                const showMapping = ref(true);
                const isFileLoading = ref(false);

                const sleep = ms => new Promise(r => setTimeout(r, ms));

                // Excel Data State
                const rawSheet = ref(null);
                const rawData = ref([]);
                const columns = ref([]);
                const headerRowIndex = ref(1);

                // API & Config
                const CONFIG = {
                    proxyUrl: "proxy.php", // Local proxy bridge
                    apiKey: "pat_wTjKHRFhTJgZNSeoEdvLae_eJDcxgoU8yIqbFKFQl64",
                    sirketID: 1,
                    subeID: 1
                };

                // Mapping Configuration (Removed Tel/EMail to strictly follow documentation)
                const apiMap = reactive({
                    CariKodu: { label: 'Cari Kodu', column: null, required: true },
                    CariAdi: { label: 'Cari Adı', column: null, required: true },
                    VergiNo: { label: 'VKN / TCKN', column: null, required: true, desc: '10 veya 11 hane' },
                    VergiDairesi: { label: 'Vergi Dairesi', column: null, required: false },
                    TabelaAdi: { label: 'Tabela Adı', column: null, required: false },
                    Kod1: { label: 'Grup Kodu (Kod 1)', column: null, required: false },
                    Kod2: { label: 'Kod 2', column: null, required: false },
                    Kod3: { label: 'Kod 3', column: null, required: false },
                    Kod4: { label: 'Kod 4', column: null, required: false },
                    Kod5: { label: 'Kod 5', column: null, required: false },
                    Kod6: { label: 'Kod 6', column: null, required: false },
                    Etiket1: { label: 'Etiket 1', column: null, required: false },
                    Etiket2: { label: 'Etiket 2', column: null, required: false },
                    Etiket3: { label: 'Etiket 3', column: null, required: false },
                    Etiket4: { label: 'Etiket 4', column: null, required: false },
                    Etiket5: { label: 'Etiket 5', column: null, required: false },
                });

                // Bulk Edit State
                const bulkEdit = reactive({
                    column: null,
                    mode: 'replace',
                    find: '',
                    replace: ''
                });

                // Processing State
                const isProcessing = ref(false);
                const stopSignal = ref(false);
                const logs = ref([]);
                const processedRows = ref(new Set());
                const processingResults = ref([]); // To store final status for report

                // Caches to avoid redundant API calls
                const caches = {
                    kodlar: {},    // format: { "level_value": ID }
                    etiketler: {}, // format: { "level_value": ID }
                    vergiDaireleri: {} // format: { "name": ID }
                };

                // Computed
                const parsedJson = computed(() => rawData.value);
                const previewRows = computed(() => rawData.value.slice(0, 100)); // Show more in preview for editor
                const requiredCount = computed(() => Object.values(apiMap).filter(v => v.required).length);
                const mappedRequiredCount = computed(() => Object.values(apiMap).filter(v => v.required && v.column).length);

                const totalCount = computed(() => rawData.value.length);
                const completedCount = computed(() => processedRows.value.size);
                const remainingCount = computed(() => totalCount.value - completedCount.value);
                const progressPercentage = computed(() => totalCount.value === 0 ? 0 : Math.round((completedCount.value / totalCount.value) * 100));

                const successCount = computed(() => logs.value.filter(l => l.type === 'success').length);
                const errorCount = computed(() => logs.value.filter(l => l.type === 'error').length);

                // Methods
                const addLog = (msg, type = 'info', row = null) => {
                    const time = new Date().toLocaleTimeString();
                    logs.value.push({ time, msg, type, row: row ? row + 1 : null });
                    nextTick(() => {
                        const el = document.getElementById('log-monitor');
                        if (el) el.scrollTop = el.scrollHeight;
                    });
                };

                const getLogClass = (type) => {
                    switch (type) {
                        case 'error': return 'text-rose-400 border-rose-900/50 bg-rose-900/10';
                        case 'success': return 'text-emerald-400 border-emerald-900/50 bg-emerald-900/10';
                        case 'warn': return 'text-amber-400 border-amber-900/50 bg-amber-900/10';
                        default: return 'text-slate-300 border-slate-800';
                    }
                };

                const getMappedField = (colName) => {
                    for (const field of Object.values(apiMap)) {
                        if (field.column === colName) return field.label;
                    }
                    return null;
                };

                const handleFileUpload = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    processFile(file);
                };

                const handleDrop = (e) => {
                    const file = e.dataTransfer.files[0];
                    if (!file) return;
                    processFile(file);
                };

                const processFile = (file) => {
                    isFileLoading.value = true;
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        await sleep(100);
                        const data = new Uint8Array(ev.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        rawSheet.value = workbook.Sheets[workbook.SheetNames[0]];
                        currentStep.value = 1;
                        isFileLoading.value = false;
                    };
                    reader.readAsArrayBuffer(file);
                };

                const resetApp = () => { if (confirm('Tüm veriler temizlenecek. Devam edilsin mi?')) location.reload(); };

                // Apply Bulk Edit
                const applyBulkEdit = async () => {
                    if (bulkEdit.mode === 'set' && !bulkEdit.column) return;
                    isFileLoading.value = true;
                    await sleep(50);
                    rawData.value = rawData.value.map(row => {
                        if (bulkEdit.column) {
                            // Action on specific column
                            let val = String(row[bulkEdit.column] || "");
                            if (bulkEdit.mode === 'replace') {
                                row[bulkEdit.column] = val.replaceAll(bulkEdit.find, bulkEdit.replace);
                            } else {
                                row[bulkEdit.column] = bulkEdit.replace;
                            }
                        } else {
                            // Action on all columns (only for replace)
                            if (bulkEdit.mode === 'replace') {
                                Object.keys(row).forEach(k => {
                                    let val = String(row[k] || "");
                                    row[k] = val.replaceAll(bulkEdit.find, bulkEdit.replace);
                                });
                            }
                        }
                        return row;
                    });
                    isFileLoading.value = false;
                    alert('Değişiklikler tüm tabloya uygulandı.');
                };

                // Watchers
                watch([headerRowIndex, rawSheet], () => {
                    if (!rawSheet.value) return;
                    const startRow = Math.max(0, headerRowIndex.value - 1);
                    const json = XLSX.utils.sheet_to_json(rawSheet.value, { range: startRow, defval: "" });
                    rawData.value = json;
                    if (json.length > 0) {
                        columns.value = Object.keys(json[0]);
                        autoMapColumns();
                    }
                });

                const autoMapColumns = () => {
                    columns.value.forEach(col => {
                        const norm = col.toLowerCase().replace(/[^a-z0-9]/g, '');
                        for (const field of Object.values(apiMap)) {
                            if (field.column) continue;
                            const labelNorm = field.label.toLowerCase().replace(/[^a-z0-9]/g, '');
                            if (norm.includes(labelNorm) || labelNorm.includes(norm)) field.column = col;
                        }
                    });
                };

                // API Functions
                const apiCall = async (endpoint, method, body = null) => {
                    try {
                        const url = `${CONFIG.proxyUrl}?endpoint=${encodeURIComponent(endpoint)}`;
                        const response = await fetch(url, {
                            method,
                            headers: {
                                'Authorization': `Bearer ${CONFIG.apiKey}`,
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: body ? JSON.stringify(body) : null
                        });
                        return await response.json();
                    } catch (e) {
                        return { Sonuc: false, Mesajlar: { Mesaj: "Proxy/Network Error: " + e.message } };
                    }
                };

                const findOrCreateKod = async (val, level) => {
                    const cacheKey = `${level}_${val}`;
                    if (caches.kodlar[cacheKey]) return caches.kodlar[cacheKey];

                    const res = await apiCall(`/api/Kodlar?Kisit.esnekAramaKisiti=${encodeURIComponent(val)}&TipAdi=Cari`, 'GET');
                    if (res.Sonuc && res.Model?.length) {
                        const match = res.Model.find(m => m.Kod === val && m.Seviye == level);
                        if (match) {
                            caches.kodlar[cacheKey] = match.KodID;
                            return match.KodID;
                        }
                    }
                    const create = await apiCall('/api/Kodlar', 'POST', { Kod: val, KodAdi: val, Seviye: level, SirketID: CONFIG.sirketID, SubeID: CONFIG.subeID, TipID: 2001, Tip2ID: 101001 });
                    if (create.Sonuc) {
                        caches.kodlar[cacheKey] = create.Model.KodID;
                        return create.Model.KodID;
                    }
                    return null;
                };

                const findOrCreateEtiket = async (val, level) => {
                    const cacheKey = `${level}_${val}`;
                    if (caches.etiketler[cacheKey]) return caches.etiketler[cacheKey];

                    const res = await apiCall(`/api/Etiketler?Kisit.esnekAramaKisiti=${encodeURIComponent(val)}&Kisit.tipID=2001`, 'GET');
                    if (res.Sonuc && res.Model?.length) {
                        const match = res.Model.find(m => m.EtiketAdi === val && m.Seviye == level);
                        if (match) {
                            caches.etiketler[cacheKey] = match.EtiketID;
                            return match.EtiketID;
                        }
                    }
                    const create = await apiCall('/api/Etiketler', 'POST', { Etiket: val, EtiketAdi: val, Seviye: level, Renk: "#3b82f6", SirketID: CONFIG.sirketID, SubeID: CONFIG.subeID, TipID: 2001, Tip2ID: 101001 });
                    if (create.Sonuc) {
                        caches.etiketler[cacheKey] = create.Model.EtiketID;
                        return create.Model.EtiketID;
                    }
                    return null;
                };

                const processRow = async (row, idx) => {
                    try {
                        const getValue = (key) => apiMap[key].column ? row[apiMap[key].column] : null;
                        const CariKodu = getValue('CariKodu'), CariAdi = getValue('CariAdi'), VergiNo = String(getValue('VergiNo') || "").replace(/\D/g, "");

                        if (!CariKodu || !CariAdi || !VergiNo) {
                            const errorMsg = 'HATA: Zorunlu veriler (Kod, Ad, VKN) eksik.';
                            addLog(errorMsg, 'error', idx);
                            processingResults.value.push({ Satir: idx + 1, CariKodu: CariKodu || 'BOŞ', CariAdi: CariAdi || 'BOŞ', Durum: 'HATA', Mesaj: 'Zorunlu alan eksik' });
                            return;
                        }

                        addLog(`İşlem başladı: ${CariAdi}`, 'info', idx);

                        // Vergi Dairesi
                        let vdID = 1;
                        const vdName = getValue('VergiDairesi');
                        if (vdName) {
                            if (caches.vergiDaireleri[vdName]) {
                                vdID = caches.vergiDaireleri[vdName];
                            } else {
                                const vdRes = await apiCall(`/api/VergiDairesi?Kisit.esnekAramaKisiti=${encodeURIComponent(vdName)}`, 'GET');
                                if (vdRes.Sonuc && vdRes.Model?.length) {
                                    vdID = vdRes.Model[0].VDID;
                                } else {
                                    const vdCr = await apiCall('/api/VergiDairesi', 'POST', { VDKodu: vdName.substring(0, 10), VDAdi: vdName, VM: "1", IlID: 34 });
                                    vdID = vdCr.Sonuc ? vdCr.Model.VDID : 1;
                                }
                                caches.vergiDaireleri[vdName] = vdID;
                            }
                        }

                        const payload = {
                            CariKodu, CariAdi, TabelaAdi: getValue('TabelaAdi') || CariAdi,
                            VergiDairesiID: vdID, VergiNo, CalismaParaBirimiID: 1,
                            MuhtelifMi: false, Vade: 0, SubeID: CONFIG.subeID, SirketID: CONFIG.sirketID,
                            Durum: true, TipID: 101001
                        };

                        // Dynamic Fields (Kod 1-6 & Etiket 1-5)
                        for (let i = 1; i <= 6; i++) {
                            const v = getValue(`Kod${i}`);
                            if (v) payload[`Kod${i}ID`] = await findOrCreateKod(v, i);
                        }
                        for (let i = 1; i <= 5; i++) {
                            const v = getValue(`Etiket${i}`);
                            if (v) payload[`Etiket${i}ID`] = await findOrCreateEtiket(v, i);
                        }

                        const result = await apiCall('/api/Cari', 'POST', payload);
                        if (result.Sonuc) {
                            addLog(`BAŞARILI: Cari açıldı (ID: ${result.Model.CariID})`, 'success', idx);
                            processedRows.value.add(idx);
                            processingResults.value.push({ Satir: idx + 1, CariKodu, CariAdi, Durum: 'BAŞARILI', Mesaj: `ID: ${result.Model.CariID}` });
                        } else {
                            const apiError = result.Mesajlar?.Mesaj || 'Bilinmeyen API Hatası';
                            addLog(`API HATASI: ${apiError}`, 'error', idx);
                            processingResults.value.push({ Satir: idx + 1, CariKodu, CariAdi, Durum: 'HATA', Mesaj: apiError });
                        }
                    } catch (e) {
                        addLog(`SİSTEM HATASI: ${e.message}`, 'error', idx);
                        processingResults.value.push({ Satir: idx + 1, Durum: 'KRİTİK HATA', Mesaj: e.message });
                    }
                };

                const startProcessing = async () => {
                    isProcessing.value = true;
                    stopSignal.value = false;
                    addLog('>>> TOPLU İŞLEM BAŞLATILDI <<<', 'warn');

                    const rows = parsedJson.value;
                    for (let i = 0; i < rows.length; i++) {
                        if (stopSignal.value) break;
                        if (processedRows.value.has(i)) continue;
                        await processRow(rows[i], i);
                        await sleep(400); // 400ms = approx 2.5 rows per second, involving multiple sub-calls safely
                    }
                    isProcessing.value = false;
                    addLog('>>> İŞLEM TAMAMLANDI <<<', 'success');
                };

                const stopProcessing = () => { stopSignal.value = true; };

                const downloadReport = () => {
                    const ws = XLSX.utils.json_to_sheet(processingResults.value);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Kuyruk Sonucu");

                    // Add secondary sheet for all logs
                    const logWs = XLSX.utils.json_to_sheet(logs.value.map(l => ({ Zaman: l.time, Satir: l.row, Tip: l.type, Mesaj: l.msg })));
                    XLSX.utils.book_append_sheet(wb, logWs, "Tüm Loglar");

                    XLSX.writeFile(wb, "Aaro_Cari_Olusturma_Raporu.xlsx");
                };

                return {
                    steps, currentStep, showMapping, headerRowIndex, columns, apiMap, bulkEdit,
                    previewRows, isProcessing, progressPercentage, totalCount, completedCount, remainingCount, successCount, errorCount,
                    logs, getLogClass, getMappedField, handleFileUpload, resetApp, applyBulkEdit, startProcessing, stopProcessing, downloadReport,
                    requiredCount, mappedRequiredCount, isFileLoading
                };
            }
        }).mount('#app');
    </script>
</body>

</html>